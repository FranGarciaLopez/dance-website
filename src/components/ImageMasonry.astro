---
// ImageMasonry.astro
import "photoswipe/dist/photoswipe.css";

interface Props {
  images: string[];
}
const { images } = Astro.props;

// Normalize current path (remove trailing slash)
const currentPath = Astro.url.pathname.replace(/\/$/, "").toLowerCase();
const isGaleria = currentPath === "/galeria";

// Images to exclude from homepage
const excludeMain = ["aiinhoa", "cann"];

// Filter images depending on route
const filteredImages = isGaleria
  ? images // show all on /galeria
  : images.filter(
      (img) => !excludeMain.some((word) => img.toLowerCase().includes(word)),
    );

// Limit homepage images
const numImages = isGaleria ? images.length : 7;
const displayedImages = filteredImages.slice(0, numImages);

const CLOUD_NAME = "dgvvnopu7";
function cldUrl(publicId: string, width?: number, height?: number) {
  const w = width ? `w_${width},` : "";
  const h = height ? `h_${height},` : "";
  return `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${w}${h}c_limit,q_auto,f_auto,dpr_auto/${publicId}.webp`;
}
---

<section class="masonry-section px-6 py-6 max-w-5xl mx-auto" id="galeria">

  <div class="masonry-grid mx-auto animate-fade-in" data-pswp-gallery>
    {
      displayedImages.map((publicId, index) => (
        <a 
          href={cldUrl(publicId, 2000)} 
          class="masonry-item block group relative overflow-hidden rounded-xl"
          data-pswp-width="2000"
          data-pswp-height="1500"
          aria-label={`Ver imagen: ${publicId.replace(/[_-]/g, " ")}`}
          style={`--animation-delay: ${index * 0.1}s;`}
        >
          <div class="aspect-box overflow-hidden rounded-xl">
            <img
              src={cldUrl(publicId, 600)}
              alt={publicId.replace(/[_-]/g, " ")}
              class="w-full h-full object-cover rounded-xl cursor-zoom-in transition-all duration-500 ease-out group-hover:scale-[1.03]"
              loading="lazy"
              width="600"
              height="450"
            />
            <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <div class="absolute bottom-3 left-3 text-sm text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 font-medium drop-shadow-md flex items-center gap-1.5">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 3h6v6"></path>
                <path d="M10 14L21 3"></path>
                <path d="M18 13v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h7"></path>
              </svg>
              Ampliar
            </div>
          </div>
        </a>
      ))
    }
  </div>

  {
    !isGaleria && (
      <div class="text-center mt-10">
        <a
          href="/galeria/"
          class="inline-flex items-center gap-2 bg-gradient-to-r from-main-gradient-from to-main-gradient-to text-white px-7 py-3 rounded-full 
          font-medium text-lg hover:scale-105 transform transition duration-300 shadow-lg hover:shadow-main-gradient-from/30"
        >
          Ver MÃ¡s Fotos
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
        </a>
      </div>
    )
  }
</section>

<style>
  .main-gradient-text {
    @apply bg-gradient-to-r from-main-gradient-from to-main-gradient-to bg-clip-text text-transparent;
  }

  .masonry-grid {
    column-count: 1;
    column-gap: 1.25rem;
  }
  
  @media (min-width: 640px) {
    .masonry-grid {
      column-count: 2;
    }
  }
  
  @media (min-width: 1024px) {
    .masonry-grid {
      column-count: 3;
    }
  }
  
  .masonry-item {
    margin-bottom: 1.25rem;
    break-inside: avoid;
    display: block;
  }

  /* PhotoSwipe image orientation */
  :global(.pswp__zoom-wrap) {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    height: 100%;
    width: 100%;
  }
  
  :global(.pswp__img) {
    margin: 0 auto !important;
    top: 0 !important;
    left: 0 !important;
    object-fit: contain !important;
    transition: opacity 0.3s ease-out;
  }
  
  :global(.pswp-portrait) {
    max-height: 90vh !important;
    width: auto !important;
  }
  
  :global(.pswp-landscape) {
    max-width: 90vw !important;
    height: auto !important;
  }
  
  :global(.pswp__bg) {
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  :global(.pswp--open) :global(.pswp__bg) {
    opacity: 0.85 !important;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .animate-fade-in {
    animation: fadeIn 1.2s ease-out forwards;
    animation-delay: var(--animation-delay, 0s);
  }
</style>
