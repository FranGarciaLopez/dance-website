---
// ImageMasonry.astro
import "photoswipe/dist/photoswipe.css";

interface Props {
  images: string[];
}
const { images } = Astro.props;

// Normalize current path (remove trailing slash)
const currentPath = Astro.url.pathname.replace(/\/$/, "").toLowerCase();
const isGaleria = currentPath === "/galeria";

// Images to exclude from homepage
const excludeMain = ["aiinhoa", "cann"];

// Filter images depending on route
const filteredImages = isGaleria
  ? images // show all on /galeria
  : images.filter(
      (img) => !excludeMain.some((word) => img.toLowerCase().includes(word)),
    );

// Limit homepage images
const numImages = isGaleria ? images.length : 7;
const displayedImages = filteredImages.slice(0, numImages);

const CLOUD_NAME = "dgvvnopu7";

// Calculate animation delay for masonry row-by-row effect
// In CSS columns, images fill vertically: col1 fills, then col2, then col3
// To animate by rows, we need to group images that appear at similar heights
function getRowDelay(index: number, totalImages: number): number {
  const numCols = 3; // desktop columns
  const imagesPerCol = Math.ceil(totalImages / numCols);
  
  // Determine which column this image is in
  const col = Math.floor(index / imagesPerCol);
  // Determine position within that column
  const posInCol = index % imagesPerCol;
  
  // Calculate approximate row (images at same posInCol are in the same visual row)
  // Prioritize row position, then add small column delay
  return (posInCol * 0.15) + (col * 0.05);
}

// Optimized Cloudinary URL generation
function cldUrl(publicId: string, width?: number, height?: number) {
  const w = width ? `w_${width},` : "";
  const h = height ? `h_${height},` : "";
  // Optimized: auto format, q_80 compression, auto DPR, progressive loading
  return `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${w}${h}c_limit,f_auto,q_80,dpr_auto,fl_progressive/${publicId}.webp`;
}

// Generate responsive srcset
function generateSrcSet(publicId: string) {
  return [
    `${cldUrl(publicId, 400)} 400w`,
    `${cldUrl(publicId, 800)} 800w`, 
    `${cldUrl(publicId, 1200)} 1200w`,
    `${cldUrl(publicId, 1600)} 1600w`
  ].join(', ');
}
---

<section class="masonry-section px-6 py-6 max-w-5xl mx-auto" id="galeria">
  <div class="masonry-grid mx-auto" data-pswp-gallery>
    {displayedImages.map((publicId, index) => (
      <a 
        href={cldUrl(publicId, 2000)} 
        class="masonry-item animate-fade-in block group relative overflow-hidden rounded-xl"
        data-pswp-width="2000"
        data-pswp-height="1500"
        aria-label={`Ver imagen: ${publicId.replace(/[_-]/g, " ")}`}
        style={`--animation-delay: ${getRowDelay(index, displayedImages.length)}s;`}
      >
        <div class="aspect-box overflow-hidden rounded-xl">
          <img
            src={cldUrl(publicId, 800)}
            srcset={generateSrcSet(publicId)}
            sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
            alt={`Foto de clase de baile - The Latin Action ${publicId.replace(/[_-]/g, " ")}`}
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
            loading={index < 4 ? "eager" : "lazy"}
            fetchpriority={index < 2 ? "high" : "auto"}
            decoding="async"
            width="800"
            height="600"
          />
        </div>
      </a>
    ))}
  </div>
</section>

<style>
  .main-gradient-text {
    @apply bg-gradient-to-r from-main-gradient-from to-main-gradient-to bg-clip-text text-transparent;
  }

  .masonry-grid {
    columns: 1;
    column-gap: 1rem;
    width: 100%;
  }
  
  @media (min-width: 640px) {
    .masonry-grid { columns: 2; }
  }
  
  @media (min-width: 1024px) {
    .masonry-grid { columns: 3; }
  }
  
  .masonry-item {
    display: inline-block;
    width: 100%;
    margin-bottom: 1rem;
    break-inside: avoid;
  }
  
  .aspect-box {
    aspect-ratio: 4/5;
  }

  /* PhotoSwipe image orientation */
  :global(.pswp__zoom-wrap) {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    height: 100%;
    width: 100%;
  }
  
  :global(.pswp__img) {
    margin: 0 auto !important;
    top: 0 !important;
    left: 0 !important;
    object-fit: contain !important;
    transition: opacity 0.3s ease-out;
  }
  
  :global(.pswp-portrait) {
    max-height: 90vh !important;
    width: auto !important;
  }
  
  :global(.pswp-landscape) {
    max-width: 90vw !important;
    height: auto !important;
  }
  
  :global(.pswp__bg) {
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  :global(.pswp--open) :global(.pswp__bg) {
    opacity: 0.85 !important;
  }
</style>
